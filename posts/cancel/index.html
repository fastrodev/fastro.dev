<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Cancel | Fastro</title>
<meta name=keywords content="go,mongodb">
<meta name=description content="Memahami cara melakukan pembatalan menggunakan context.WithTimeout di mongodb">
<meta name=author content="
Admin">
<link rel=canonical href=https://fastro.dev/posts/cancel/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c5b21ba3e7fcf6cf4864656416c0b45547191189c7a1c61e231ae02b81609c4b.css integrity="sha256-xbIbo+f89s9IZGVkFsC0VUcZEYnHocYeIxrgK4FgnEs=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fastro.dev/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://fastro.dev/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://fastro.dev/favicon-32x32.png>
<link rel=apple-touch-icon href=https://fastro.dev/apple-touch-icon.png>
<link rel=mask-icon href=https://fastro.dev/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.2">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-165990288-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="Cancel">
<meta property="og:description" content="Memahami cara melakukan pembatalan menggunakan context.WithTimeout di mongodb">
<meta property="og:type" content="article">
<meta property="og:url" content="https://fastro.dev/posts/cancel/"><meta property="og:image" content="https://fastro.dev/seo.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-12-27T00:00:00+00:00">
<meta property="article:modified_time" content="2021-12-27T00:00:00+00:00">
<meta property="og:see_also" content="https://fastro.dev/posts/context/"><meta property="og:see_also" content="https://fastro.dev/posts/marshal/"><meta property="og:see_also" content="https://fastro.dev/posts/repository/"><meta property="og:see_also" content="https://fastro.dev/posts/mongodb/"><meta property="og:see_also" content="https://fastro.dev/posts/module/">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://fastro.dev/seo.png">
<meta name=twitter:title content="Cancel">
<meta name=twitter:description content="Memahami cara melakukan pembatalan menggunakan context.WithTimeout di mongodb">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://fastro.dev/posts/"},{"@type":"ListItem","position":3,"name":"Cancel","item":"https://fastro.dev/posts/cancel/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Cancel","name":"Cancel","description":"Memahami cara melakukan pembatalan menggunakan context.WithTimeout di mongodb","keywords":["go","mongodb"],"articleBody":"Catatan ini berisi penjelasan se-simple mungkin tentang cara pembatalan (cancel) menggunakan context.WithTimeout di mongodb.\nPendahuluan Pada catatan sebelumnya, kita telah membuat simulasi penerapan context.WithTimeout secara sederhana untuk mengetahui cara kerjanya. Kali ini kita akan menerapkannya di mongodb.\nUbah repository type repository struct { coll *mongo.Collection timeout time.Duration } Kita tambahkan timeout agar bisa diakses di setiap method. Ini dilakukan agar tidak terjadi pengulangan deklarasi di setiap method.\nUbah instance repository func createBookRepository( ctx context.Context, timeout time.Duration, uri, db, col string, ) *repository { ctx, cancel := context.WithTimeout(ctx, timeout) defer cancel() client, err := mongo.Connect(ctx, options.Client().ApplyURI(uri)) if err != nil { panic(err) } return \u0026repository{ coll: client.Database(db).Collection(col), timeout: timeout, } } Kita tambahkan argument baru untuk timeout. Argumen baru ini kita gunakan untuk inisialisasi ctx dan injeksi struct repository.\nMasukkan context dan panggil cancel di setiap method func (r *repository) createBook(ctx context.Context, book Book) (*Book, error) { ctx, cancel := context.WithTimeout(ctx, r.timeout) defer cancel() res, err := r.coll.InsertOne(ctx, book) if err != nil { return nil, err } book.ID = res.InsertedID.(primitive.ObjectID) return \u0026book, nil } Perhatikan, kita telah buat inisialiasi context.WithTimeout menggunakan timeout yang telah kita injeksi melalui repository.\nCara pemakaian Setelah signature fungsi dan method telah diubah, cara pemanggilannya juga perlu kita sesuaikan lagi:\nfunc main() { uri := \"mongodb+srv://admin:admin@cluster0.xtwwu.mongodb.net\" database := \"myDB\" collection := \"favorite_books\" ctx := context.Background() timeout := 10 * time.Second repo := createBookRepository(ctx, timeout, uri, database, collection) result, err := repo.createBook( ctx, Book{ Title: \"Invisible Cities\", Author: \"Italo Calvino\", Year: 1974, }, ) if err != nil { panic(err) } fmt.Printf(\"Inserted document with _id: %v\\n\", result.ID) } Kode selengkapnya: lihat di sini\nPerhatikan bahwa inisialisasi context dan timeout cukup dilakukan sekali. Dan ia digunakan oleh semua fungsi dan method.\nJika kita jalankan, hasilnya:\nInserted document with _id: ObjectID(\"61c8f92ba3e486cbdc3ee68b\") ","wordCount":"292","inLanguage":"en","datePublished":"2021-12-27T00:00:00Z","dateModified":"2021-12-27T00:00:00Z","author":{"@type":"Person","name":"Admin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fastro.dev/posts/cancel/"},"publisher":{"@type":"Organization","name":"Fastro","logo":{"@type":"ImageObject","url":"https://fastro.dev/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class="main-header header">
<nav class=nav>
<div class=logo>
<a href=https://fastro.dev accesskey=h title="Fastro (Alt + H)">
Fastro</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
</nav>
</header><main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Cancel
</h1>
<div class=post-meta><span title="2021-12-27 00:00:00 +0000 UTC">December 27, 2021</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;
<a href=/authors/admin/>Admin</a>&nbsp;|&nbsp;<a href=https://github.com/fastrodev/fastrodev.github.io/blob/main/content/posts/cancel.md rel="noopener noreferrer" target=_blank>Update</a>
</div>
</header> <div class=toc>
<details open>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#pendahuluan aria-label=Pendahuluan>Pendahuluan</a></li>
<li>
<a href=#ubah-repository aria-label="Ubah repository">Ubah repository</a></li>
<li>
<a href=#ubah-instance-repository aria-label="Ubah instance repository">Ubah instance repository</a></li>
<li>
<a href=#masukkan-context-dan-panggil-cancel-di-setiap-method aria-label="Masukkan context dan panggil cancel di setiap method">Masukkan context dan panggil cancel di setiap method</a></li>
<li>
<a href=#cara-pemakaian aria-label="Cara pemakaian">Cara pemakaian</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>Catatan ini berisi penjelasan se-<em>simple</em> mungkin tentang cara pembatalan <em>(cancel)</em> menggunakan <code>context.WithTimeout</code> di mongodb.</p>
<h3 id=pendahuluan>Pendahuluan<a hidden class=anchor aria-hidden=true href=#pendahuluan>#</a></h3>
<p>Pada <a href=/posts/context/>catatan sebelumnya</a>, kita telah membuat simulasi penerapan <code>context.WithTimeout</code> secara sederhana untuk mengetahui cara kerjanya. Kali ini kita akan menerapkannya di mongodb.</p>
<h3 id=ubah-repository>Ubah repository<a hidden class=anchor aria-hidden=true href=#ubah-repository>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#fff;font-weight:700>type</span> repository <span style=color:#fff;font-weight:700>struct</span> {
	coll    *mongo.Collection
	timeout time.Duration
}
</code></pre></div><p>Kita tambahkan <code>timeout</code> agar bisa diakses di setiap method. Ini dilakukan agar tidak terjadi pengulangan deklarasi di setiap method.</p>
<h3 id=ubah-instance-repository>Ubah instance repository<a hidden class=anchor aria-hidden=true href=#ubah-instance-repository>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#fff;font-weight:700>func</span> createBookRepository(
	ctx context.Context,
	timeout time.Duration,
	uri, db, col <span style=color:#fff;font-weight:700>string</span>,
) *repository {
	ctx, cancel := context.WithTimeout(ctx, timeout)
	<span style=color:#fff;font-weight:700>defer</span> cancel()

	client, err := mongo.Connect(ctx, options.Client().ApplyURI(uri))
	<span style=color:#fff;font-weight:700>if</span> err != <span style=color:#fff;font-weight:700>nil</span> {
		<span style=color:#fff;font-weight:700>panic</span>(err)
	}
	<span style=color:#fff;font-weight:700>return</span> &amp;repository{
		coll:    client.Database(db).Collection(col),
		timeout: timeout,
	}
}
</code></pre></div><p>Kita tambahkan argument baru untuk <code>timeout</code>. Argumen baru ini kita gunakan untuk inisialisasi <code>ctx</code> dan injeksi struct <code>repository</code>.</p>
<h3 id=masukkan-context-dan-panggil-cancel-di-setiap-method>Masukkan context dan panggil cancel di setiap method<a hidden class=anchor aria-hidden=true href=#masukkan-context-dan-panggil-cancel-di-setiap-method>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#fff;font-weight:700>func</span> (r *repository) createBook(ctx context.Context, book Book) (*Book, <span style=color:#fff;font-weight:700>error</span>) {
	ctx, cancel := context.WithTimeout(ctx, r.timeout)
	<span style=color:#fff;font-weight:700>defer</span> cancel()

	res, err := r.coll.InsertOne(ctx, book)
	<span style=color:#fff;font-weight:700>if</span> err != <span style=color:#fff;font-weight:700>nil</span> {
		<span style=color:#fff;font-weight:700>return</span> <span style=color:#fff;font-weight:700>nil</span>, err
	}

	book.ID = res.InsertedID.(primitive.ObjectID)
	<span style=color:#fff;font-weight:700>return</span> &amp;book, <span style=color:#fff;font-weight:700>nil</span>
}
</code></pre></div><p>Perhatikan, kita telah buat inisialiasi <code>context.WithTimeout</code> menggunakan <code>timeout</code> yang telah kita injeksi melalui <code>repository</code>.</p>
<h3 id=cara-pemakaian>Cara pemakaian<a hidden class=anchor aria-hidden=true href=#cara-pemakaian>#</a></h3>
<p>Setelah signature fungsi dan method telah diubah, cara pemanggilannya juga perlu kita sesuaikan lagi:</p>
<div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#fff;font-weight:700>func</span> main() {
	uri := <span style=color:#0ff;font-weight:700>&#34;mongodb+srv://admin:admin@cluster0.xtwwu.mongodb.net&#34;</span>
	database := <span style=color:#0ff;font-weight:700>&#34;myDB&#34;</span>
	collection := <span style=color:#0ff;font-weight:700>&#34;favorite_books&#34;</span>
	ctx := context.Background()
	timeout := <span style=color:#ff0;font-weight:700>10</span> * time.Second
	repo := createBookRepository(ctx, timeout, uri, database, collection)

	result, err := repo.createBook(
		ctx,
		Book{
			Title:  <span style=color:#0ff;font-weight:700>&#34;Invisible Cities&#34;</span>,
			Author: <span style=color:#0ff;font-weight:700>&#34;Italo Calvino&#34;</span>,
			Year:   <span style=color:#ff0;font-weight:700>1974</span>,
		},
	)
	<span style=color:#fff;font-weight:700>if</span> err != <span style=color:#fff;font-weight:700>nil</span> {
		<span style=color:#fff;font-weight:700>panic</span>(err)
	}
	fmt.Printf(<span style=color:#0ff;font-weight:700>&#34;Inserted document with _id: %v\n&#34;</span>, result.ID)
}
</code></pre></div><p><em>Kode selengkapnya: <a href=https://github.com/fastrodev/praktikum-repository/blob/cancel/main.go>lihat di sini</a></em></p>
<p>Perhatikan bahwa inisialisasi <code>context</code> dan <code>timeout</code> cukup dilakukan sekali. Dan ia digunakan oleh semua fungsi dan method.</p>
<p>Jika kita jalankan, hasilnya:</p>
<div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>Inserted document with _id: ObjectID(&#34;61c8f92ba3e486cbdc3ee68b&#34;)
</code></pre></div>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://fastro.dev/tags/go/>go</a></li>
<li><a href=https://fastro.dev/tags/mongodb/>mongodb</a></li>
</ul>
<nav class=paginav>
<a class=next href=https://fastro.dev/posts/context/>
<span class=title>Next Page »</span>
<br>
<span>Context with timeout</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://fastro.dev>Fastro</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>